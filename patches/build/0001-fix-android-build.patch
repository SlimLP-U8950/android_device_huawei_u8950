From ec3b181a735d42326288c19392d24b8d043bccbd Mon Sep 17 00:00:00 2001
From: ksrt12 <kazakov12stepan2012@live.ru>
Date: Tue, 3 Nov 2015 22:38:31 +0600
Subject: [PATCH] fix android build

Change-Id: Ia6e73e0689e9783989619e57eb20ead69ab14cf9
---
 core/Makefile               |  7 +++++++
 core/qcom_target.mk         |  2 +-
 core/tasks/kernel.mk        | 18 ++++++++++++++++--
 envsetup.sh                 | 19 +++++++++++++++++++
 target/product/full_base.mk |  2 +-
 5 files changed, 44 insertions(+), 4 deletions(-)

diff --git a/core/Makefile b/core/Makefile
index 2585ded..58025f1 100644
--- a/core/Makefile
+++ b/core/Makefile
@@ -1670,6 +1670,13 @@ bootzip: bootimage
 	   $(OUT) \
 	   $(TARGET_DEVICE)
 
+ifeq ($(USE_PREBUILT_CHROMIUM),1)
+ifneq ($(PRODUCT_PREBUILT_WEBVIEWCHROMIUM),yes)
+	@echo "Running Chromium prebuilt setup script..."
+	$(hide) . $(TOPDIR)vendor/slim/utils/chromium_prebuilt.sh $(TOP)
+endif
+endif
+
 endif    # recovery_fstab is defined
 endif    # TARGET_NO_KERNEL != true
 endif    # TARGET_DEVICE != generic*
diff --git a/core/qcom_target.mk b/core/qcom_target.mk
index fcefe00..3153885 100644
--- a/core/qcom_target.mk
+++ b/core/qcom_target.mk
@@ -17,7 +17,7 @@ ifeq ($(BOARD_USES_QCOM_HARDWARE),true)
     TARGET_ENABLE_QC_AV_ENHANCEMENTS := true
 
     # Enable DirectTrack for legacy targets
-    ifneq ($(filter msm7x30 msm8660 msm8960,$(TARGET_BOARD_PLATFORM)),)
+    ifneq ($(filter msm7x27a msm7x30 msm8660 msm8960,$(TARGET_BOARD_PLATFORM)),)
         ifeq ($(BOARD_USES_LEGACY_ALSA_AUDIO),true)
             qcom_flags += -DQCOM_DIRECTTRACK
         endif
diff --git a/core/tasks/kernel.mk b/core/tasks/kernel.mk
index 2c49271..5704f32 100644
--- a/core/tasks/kernel.mk
+++ b/core/tasks/kernel.mk
@@ -166,7 +166,21 @@ ifneq ($(USE_CCACHE),)
     ccache := $(strip $(wildcard $(ccache)))
 endif
 
-KERNEL_CROSS_COMPILE := CROSS_COMPILE="$(ccache) $(KERNEL_TOOLCHAIN_PATH)"
+ifneq ($(TARGET_KERNEL_CUSTOM_TOOLCHAIN),)
+    ifeq ($(HOST_OS),darwin)
+        TARGET_KERNEL_CUSTOM_TOOLCHAIN_PATH := prebuilt/darwin-x86/toolchain
+    else
+        TARGET_KERNEL_CUSTOM_TOOLCHAIN_PATH := prebuilt/linux-x86/toolchain
+    endif
+else
+    ifeq ($(HOST_OS),darwin)
+        TARGET_KERNEL_CUSTOM_TOOLCHAIN_PATH := prebuilts/gcc/darwin-x86/arm/arm-linux-androideabi-4.9/bin
+    else
+        TARGET_KERNEL_CUSTOM_TOOLCHAIN_PATH := prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9/bin
+    endif
+    TARGET_KERNEL_CUSTOM_TOOLCHAIN := arm-eabi-
+endif
+ KERNEL_CROSS_COMPILE:=CROSS_COMPILE="$(ccache) $(ANDROID_BUILD_TOP)/$(TARGET_KERNEL_CUSTOM_TOOLCHAIN_PATH)/$(TARGET_KERNEL_CUSTOM_TOOLCHAIN)"
 ccache =
 
 define mv-modules
@@ -174,7 +188,7 @@ define mv-modules
     if [ "$$mdpath" != "" ];then\
         mpath=`dirname $$mdpath`;\
         ko=`find $$mpath/kernel -type f -name *.ko`;\
-        for i in $$ko; do $(KERNEL_TOOLCHAIN_PATH)strip --strip-unneeded $$i;\
+        for i in $$ko; do $(ANDROID_BUILD_TOP)/$(TARGET_KERNEL_CUSTOM_TOOLCHAIN_PATH)/$(TARGET_KERNEL_CUSTOM_TOOLCHAIN)strip --strip-unneeded $$i;\
         mv $$i $(KERNEL_MODULES_OUT)/; done;\
     fi
 endef
diff --git a/envsetup.sh b/envsetup.sh
index d9d61ca..b4a218b 100644
--- a/envsetup.sh
+++ b/envsetup.sh
@@ -643,6 +643,13 @@ function lunch()
 
     echo
 
+    if [[ $USE_PREBUILT_CHROMIUM -eq 1 ]]; then
+        chromium_prebuilt
+    else
+        # Unset flag in case user opts out later on
+        export PRODUCT_PREBUILT_WEBVIEWCHROMIUM=""
+    fi
+
     set_stuff_for_environment
     printconfig
 }
@@ -1798,7 +1805,19 @@ function make()
     return $ret
 }
 
+function chromium_prebuilt() {
+    T=$(gettop)
+    export TARGET_DEVICE=$(get_build_var TARGET_DEVICE)
+    hash=$T/prebuilts/chromium/$TARGET_DEVICE/hash.txt
 
+    if [ -r $hash ] && [ $(git --git-dir=$T/external/chromium_org/.git --work-tree=$T/external/chromium_org rev-parse --verify HEAD) == $(cat $hash) ]; then
+        export PRODUCT_PREBUILT_WEBVIEWCHROMIUM=yes
+        echo "** Prebuilt Chromium is up-to-date; Will be used for build **"
+    else
+        export PRODUCT_PREBUILT_WEBVIEWCHROMIUM=no
+        echo "** Prebuilt Chromium out-of-date/not found; Will build from source **"
+    fi
+}
 
 if [ "x$SHELL" != "x/bin/bash" ]; then
     case `ps -o command -p $$` in
diff --git a/target/product/full_base.mk b/target/product/full_base.mk
index 5e59f8a..fc0eec9 100644
--- a/target/product/full_base.mk
+++ b/target/product/full_base.mk
@@ -34,7 +34,7 @@ PRODUCT_PROPERTY_OVERRIDES := \
     ro.config.notification_sound=Io.ogg
 
 # Put en_US first in the list, so make it default.
-PRODUCT_LOCALES := en_US
+PRODUCT_LOCALES := ru_RU
 
 # Include drawables for all densities
 PRODUCT_AAPT_CONFIG := normal hdpi xhdpi xxhdpi
-- 
2.1.4

